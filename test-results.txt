npm WARN config cache-min This option has been deprecated in favor of `--prefer-offline`.

> @tg-payment/api@0.1.0 test
> dotenv -e .env.test -- jest --passWithNoTests --forceExit

PASS src/__tests__/integration/unmatched-deposits.test.ts (5.306 s)
  â— Console

    console.log
      âœ… @tg-payment/core v2.0.0 initialized

      at Object.<anonymous> (../core/src/index.ts:118:9)

    console.log
      ğŸ”— Integration: Direct TON Blockchain (No Fragment API)

      at Object.<anonymous> (../core/src/index.ts:119:9)

    console.log
      ğŸ“¦ Features: No KYC | No Holding Period | Instant Withdrawals

      at Object.<anonymous> (../core/src/index.ts:120:9)

    console.log
      Received TON transaction webhook: {
        tx_hash: 'unmatched_tx_hash',
        sender: 'some_ton_address',
        amount: '1000000000',
        destination: 'our_custodial_wallet_address'
      }

      at handleTonTransaction (src/controllers/webhook.controller.ts:9:21)

PASS src/__tests__/integration/conversions.test.ts
  â— Console

    console.log
      âœ… @tg-payment/core v2.0.0 initialized

      at Object.<anonymous> (../core/src/index.ts:118:9)

    console.log
      ğŸ”— Integration: Direct TON Blockchain (No Fragment API)

      at Object.<anonymous> (../core/src/index.ts:119:9)

    console.log
      ğŸ“¦ Features: No KYC | No Holding Period | Instant Withdrawals

      at Object.<anonymous> (../core/src/index.ts:120:9)

    console.log
      ğŸ§ª RateAggregatorService running in simulation mode

      at new RateAggregatorService (../core/src/services/rate.aggregator.ts:34:21)

    console.log
      ğŸ“Š Fetching rates: TON â†’ USD

      at RateAggregatorService.getAggregatedRate (../core/src/services/rate.aggregator.ts:69:17)

    console.log
      ğŸ§ª Simulated rates for TON â†’ USD: [
        {
          source: 'coingecko',
          value: 2.1607499999999997,
          timestamp: 1763906541434
        },
        {
          source: 'dexscreener',
          value: 2.1456999999999997,
          timestamp: 1763906541434
        },
        { source: 'coinmarketcap', value: 2.1543, timestamp: 1763906541434 }
      ]

      at RateAggregatorService.getSimulatedRate (../core/src/services/rate.aggregator.ts:301:17)

FAIL src/__tests__/integration/auth.flow.test.ts
  â— Console

    console.log
      âœ… @tg-payment/core v2.0.0 initialized

      at Object.<anonymous> (../core/src/index.ts:118:9)

    console.log
      ğŸ”— Integration: Direct TON Blockchain (No Fragment API)

      at Object.<anonymous> (../core/src/index.ts:119:9)

    console.log
      ğŸ“¦ Features: No KYC | No Holding Period | Instant Withdrawals

      at Object.<anonymous> (../core/src/index.ts:120:9)

    console.log
      Magic link (no SMTP): eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImludC10ZXN0LTE3NjM5MDY1NDIxMDBAZXhhbXBsZS5jb20iLCJpYXQiOjE3NjM5MDY1NDIsImV4cCI6MTc2MzkwNzQ0MiwianRpIjoiMGVmYTc3NzMyYTdkYWYzY2Y1Yjc1ZTk5OTU5YWZjY2EifQ.TSY9mod9FD5Y_nZ9cuTPvik2gc6ZKfHyhWkkIk0cP-o

      at Function.requestMagicLink (../core/dist/services/auth.service.js:87:25)

  â— magic link verify -> session cookie -> /auth/me

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 404

      24 |
      25 |   // Call verify endpoint using agent to persist cookies
    > 26 |   const resVerify = await agent.post('/api/v1/auth/magic-link/verify').send({ token: req.token });
         |                              ^
      27 |   expect(resVerify.status).toBe(200);
      28 |
      29 |   // Use agent to call /auth/me (cookies are automatically sent)

      at Object.<anonymous> (src/__tests__/integration/auth.flow.test.ts:26:30)

PASS src/__tests__/integration/payments.webhook.test.ts
  â— Console

    console.log
      âœ… @tg-payment/core v2.0.0 initialized

      at Object.<anonymous> (../core/src/index.ts:118:9)

    console.log
      ğŸ”— Integration: Direct TON Blockchain (No Fragment API)

      at Object.<anonymous> (../core/src/index.ts:119:9)

    console.log
      ğŸ“¦ Features: No KYC | No Holding Period | Instant Withdrawals

      at Object.<anonymous> (../core/src/index.ts:120:9)

    console.warn
      âš ï¸ Normalized non-UUID user id "test-user-1" to deterministic uuid 3aaff40c-66c3-5af4-a2e1-0fe7c771bd2d

      226 |   ): Promise<void> {
      227 |     try {
    > 228 |       const userId = req.headers['x-user-id'] as string;
          |                 ^
      229 |       if (!userId) {
      230 |         res.status(400).json({
      231 |           success: false,

      at Function.normalizeUserId (src/controllers/payment.controller.ts:228:17)
      at handleTelegramWebhook (src/controllers/payment.controller.ts:27:56)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (../../node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at ../../node_modules/express/lib/router/index.js:284:15
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Function.handle (../../node_modules/express/lib/router/index.js:175:3)
      at router (../../node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at ../../node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (../../node_modules/raw-body/index.js:238:16)
      at done (../../node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (../../node_modules/raw-body/index.js:287:7)

    console.log
      [Webhook] Received x-user-id: test-user-1, normalized: 3aaff40c-66c3-5af4-a2e1-0fe7c771bd2d

      at handleTelegramWebhook (src/controllers/payment.controller.ts:28:21)

    console.log
      [Webhook] Ensuring user exists: 3aaff40c-66c3-5af4-a2e1-0fe7c771bd2d

      at handleTelegramWebhook (src/controllers/payment.controller.ts:30:21)

    console.log
      [Webhook] User provisioning complete for: 3aaff40c-66c3-5af4-a2e1-0fe7c771bd2d

      at handleTelegramWebhook (src/controllers/payment.controller.ts:32:21)

    console.log
      ğŸ“¥ Webhook received: { userId: '3aaff40c-66c3-5af4-a2e1-0fe7c771bd2d', hasPayment: true }

      at handleTelegramWebhook (src/controllers/payment.controller.ts:40:21)

    console.log
      ğŸ’° Processing payment: { amount: 1000, currency: undefined, chargeId: 'charge_abc' }

      at TelegramService.processSuccessfulPayment (../core/src/services/Telegram.service.ts:73:17)

    console.log
      âœ… Telegram payment persisted: 566e13f5-fce9-42b9-beef-f26e0c25d0db

      at TelegramService.processSuccessfulPayment (../core/src/services/Telegram.service.ts:91:21)

    console.log
      âœ… Payment created: 566e13f5-fce9-42b9-beef-f26e0c25d0db

      at handleTelegramWebhook (src/controllers/payment.controller.ts:47:25)

    console.log
      ğŸ’° Platform fee created for payment: 566e13f5-fce9-42b9-beef-f26e0c25d0db

      at handleTelegramWebhook (src/controllers/payment.controller.ts:54:29)


Test Suites: 1 failed, 3 passed, 4 total
Tests:       1 failed, 4 passed, 5 total
Snapshots:   0 total
Time:        7.461 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
npm ERR! Lifecycle script `test` failed with error: 
npm ERR! Error: command failed 
npm ERR!   in workspace: @tg-payment/api@0.1.0 
npm ERR!   at location: /workspaces/telegram-payment-gateway/packages/api 

> @tg-payment/core@0.1.0 test
> jest --forceExit

PASS src/__tests__/auth.service.test.ts
PASS src/__tests__/unit/services.test.ts
  â— Console

    console.log
      ğŸ’° Processing payment: { amount: undefined, currency: 'XTR', chargeId: undefined }

      at TelegramService.processSuccessfulPayment (src/services/Telegram.service.ts:143:13)

    console.warn
      âš ï¸ PaymentModel not configured, returning ephemeral record

      166 |     }
      167 |
    > 168 |     console.warn('âš ï¸ PaymentModel not configured, returning ephemeral record');
          |             ^
      169 |     return {
      170 |       id: payment.telegram_payment_charge_id,
      171 |       userId,

      at TelegramService.processSuccessfulPayment (src/services/Telegram.service.ts:168:13)
      at Object.<anonymous> (src/__tests__/unit/services.test.ts:27:29)

    console.error
      âŒ Failed to set Telegram webhook: TelegramError: 404: Not Found
          at Telegram.callApi (/workspaces/telegram-payment-gateway/node_modules/telegraf/lib/core/network/client.js:315:19)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at TelegramService.initializeWebhook (/workspaces/telegram-payment-gateway/packages/core/src/services/Telegram.service.ts:87:7)
          at Object.<anonymous> (/workspaces/telegram-payment-gateway/packages/core/src/__tests__/unit/services.test.ts:42:22) {
        response: { ok: false, error_code: 404, description: 'Not Found' },
        on: {
          method: 'setWebhook',
          payload: { url: 'https://example.com/webhook' }
        }
      }

      88 |       console.log(`âœ… Telegram webhook set to: ${webhookUrl}`);
      89 |     } catch (error) {
    > 90 |       console.error('âŒ Failed to set Telegram webhook:', error);
         |               ^
      91 |       throw error;
      92 |     }
      93 |   }

      at TelegramService.initializeWebhook (src/services/Telegram.service.ts:90:15)
      at Object.<anonymous> (src/__tests__/unit/services.test.ts:42:22)

    console.log
      ğŸ§ª RateAggregatorService running in simulation mode

      at new RateAggregatorService (src/services/rate.aggregator.ts:49:15)

    console.log
      ğŸ“Š Fetching rates: TON â†’ USD

      at RateAggregatorService.getAggregatedRate (src/services/rate.aggregator.ts:89:13)

    console.log
      ğŸ§ª Simulated rates for TON â†’ USD: [
        {
          source: 'coingecko',
          value: 2.1607499999999997,
          timestamp: 1763906547094
        },
        {
          source: 'dexscreener',
          value: 2.1456999999999997,
          timestamp: 1763906547094
        },
        { source: 'coinmarketcap', value: 2.1543, timestamp: 1763906547094 }
      ]

      at RateAggregatorService.getSimulatedRate (src/services/rate.aggregator.ts:381:13)

    console.log
      ğŸ§ª RateAggregatorService running in simulation mode

      at new RateAggregatorService (src/services/rate.aggregator.ts:49:15)

    console.log
      ğŸ“Š Fetching rates: BTC â†’ USD

      at RateAggregatorService.getAggregatedRate (src/services/rate.aggregator.ts:89:13)

    console.log
      ğŸ§ª Simulated rates for BTC â†’ USD: [
        {
          source: 'coingecko',
          value: 45224.99999999999,
          timestamp: 1763906547096
        },
        { source: 'dexscreener', value: 44910, timestamp: 1763906547096 },
        { source: 'coinmarketcap', value: 45090, timestamp: 1763906547096 }
      ]

      at RateAggregatorService.getSimulatedRate (src/services/rate.aggregator.ts:381:13)

PASS src/__tests__/unit/settlement.service.test.ts
  â— Console

    console.log
      ğŸ’¸ Executing fiat payout: 55 USD to user user-1

      at SettlementService.executeFiatPayout (src/services/settlement.service.ts:199:13)

    console.log
      âœ… Settlement completed { settlementId: 'settlement-1', conversionId: 'conversion-1' }

      at SettlementService.completePendingSettlements (src/services/settlement.service.ts:181:15)

PASS src/__tests__/integration.test.ts
  â— Console

    console.log
      âœ… Fee recorded: {
        feeCollectionId: undefined,
        conversionId: undefined,
        feeAmountStars: NaN,
        feeAmountTon: NaN
      }

      at FeeService.recordFee (src/services/fee.service.ts:101:13)

    console.log
      âœ… Conversion created with fees: {
        id: undefined,
        stars: 1000,
        ton: NaN,
        platformFee: NaN,
        platformFeeTon: NaN
      }

      at ConversionService.createConversion (src/services/conversion.service.ts:229:13)

    console.log
      âœ… Conversion reconciled: bf08827e-7d3e-4179-9577-6089f7206a82 - Status: matched

      at ReconciliationService.reconcileConversion (src/services/reconciliation.service.ts:106:13)

    console.log
      âœ… P2P/DEX conversion submitted: { conversionId: undefined, provider: undefined, txHash: 'tx-hash' }

      at ConversionService.executeP2PConversion (src/services/conversion.service.ts:286:17)

PASS src/__tests__/integration/dedust-swap.test.ts
  â— Console

    console.log
      ğŸ§ª DeDust integration tests running in simulation mode

      at Object.<anonymous> (src/__tests__/integration/dedust-swap.test.ts:16:11)

PASS src/__tests__/unit/wallet-manager.service.test.ts
PASS src/__tests__/rate.aggregator.test.ts
  â— Console

    console.log
      ğŸ§ª RateAggregatorService running in simulation mode

      at new RateAggregatorService (src/services/rate.aggregator.ts:49:15)

    console.log
      ğŸ§ª RateAggregatorService running in simulation mode

      at new RateAggregatorService (src/services/rate.aggregator.ts:49:15)

    console.log
      ğŸ§ª RateAggregatorService running in simulation mode

      at new RateAggregatorService (src/services/rate.aggregator.ts:49:15)

    console.log
      ğŸ“Š Fetching rates: TON â†’ USD

      at RateAggregatorService.getAggregatedRate (src/services/rate.aggregator.ts:89:13)

PASS src/__tests__/integration/stonfi-swap.test.ts
  â— Console

    console.log
      ğŸ§ª Ston.fi integration tests running in simulation mode

      at Object.<anonymous> (src/__tests__/integration/stonfi-swap.test.ts:15:11)

PASS src/__tests__/conversion.service.test.ts
  â— Console

    console.log
      âœ… Fee fee-id marked as collected.

      at FeeService.markFeeCollected (src/services/fee.service.ts:114:13)

    console.log
      âœ… Conversion completed: {
        conversionId: '83f76de6-5b72-4ab1-bc7c-a10f3719949f',
        txHash: 'tx-hash'
      }

      at src/services/conversion.service.ts:348:23

PASS src/__tests__/unit/basic.test.ts
  â— Console

    console.log
      ğŸ§ª RateAggregatorService running in simulation mode

      at new RateAggregatorService (src/services/rate.aggregator.ts:49:15)

    console.log
      ğŸ“Š Fetching rates: TON â†’ USD

      at RateAggregatorService.getAggregatedRate (src/services/rate.aggregator.ts:89:13)

    console.log
      ğŸ§ª Simulated rates for TON â†’ USD: [
        {
          source: 'coingecko',
          value: 2.1607499999999997,
          timestamp: 1763906549203
        },
        {
          source: 'dexscreener',
          value: 2.1456999999999997,
          timestamp: 1763906549203
        },
        { source: 'coinmarketcap', value: 2.1543, timestamp: 1763906549203 }
      ]

      at RateAggregatorService.getSimulatedRate (src/services/rate.aggregator.ts:381:13)

PASS src/__tests__/reconciliation.service.test.ts
  â— Console

    console.log
      âœ… Conversion reconciled: conv-id - Status: matched

      at ReconciliationService.reconcileConversion (src/services/reconciliation.service.ts:106:13)

PASS src/__tests__/transaction-monitor.test.ts
  â— Console

    console.log
      âœ… Transaction confirmed: hash-123 for conversion conv-123

      at TransactionMonitorService.checkConversionStatus (src/services/transaction-monitor.service.ts:72:17)

    console.error
      âŒ Transaction failed: hash-456 for conversion conv-456

      94 |
      95 |       } else if (tx && tx.confirmed && !tx.success) {
    > 96 |         console.error(`âŒ Transaction failed: ${txHash} for conversion ${conversion.id}`);
         |                 ^
      97 |         await this.db.none(
      98 |           `UPDATE conversions 
      99 |            SET status = 'failed', error_message = $1, updated_at = NOW()

      at TransactionMonitorService.checkConversionStatus (src/services/transaction-monitor.service.ts:96:17)
      at TransactionMonitorService.checkPendingTransactions (src/services/transaction-monitor.service.ts:57:9)
      at Object.<anonymous> (src/__tests__/transaction-monitor.test.ts:61:5)

PASS src/__tests__/unit/deposit-monitor.service.test.ts
  â— Console

    console.log
      ğŸ›°ï¸ Deposit monitor running (interval=10ms, confirmations=1)

      at DepositMonitorService.start (src/services/deposit-monitor.service.ts:42:13)

    console.log
      âœ… Manual deposit confirmed {
        depositId: 'deposit-1',
        paymentId: 'payment-1',
        conversionId: undefined,
        txHash: 'abc'
      }

      at DepositMonitorService.confirmDeposit (src/services/deposit-monitor.service.ts:153:13)

FAIL src/__tests__/auth.totp.test.ts
  â— Test suite failed to run

    [96msrc/__tests__/auth.totp.test.ts[0m:[93m35[0m:[93m9[0m - [91merror[0m[90m TS2451: [0mCannot redeclare block-scoped variable 'match'.

    [7m35[0m   const match = codes.some((r: any) => r.code_hash === 'code1');
    [7m  [0m [91m        ~~~~~[0m
    [96msrc/__tests__/auth.totp.test.ts[0m:[93m36[0m:[93m9[0m - [91merror[0m[90m TS2451: [0mCannot redeclare block-scoped variable 'match'.

    [7m36[0m   const match = codes.some((r: unknown) => (r as { code_hash: string }).code_hash === 'code1');
    [7m  [0m [91m        ~~~~~[0m

Test Suites: 1 failed, 13 passed, 14 total
Tests:       2 skipped, 38 passed, 40 total
Snapshots:   0 total
Time:        6.402 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
npm ERR! Lifecycle script `test` failed with error: 
npm ERR! Error: command failed 
npm ERR!   in workspace: @tg-payment/core@0.1.0 
npm ERR!   at location: /workspaces/telegram-payment-gateway/packages/core 

> @tg-payment/dashboard@0.0.0 test
> vitest run


 RUN  v1.6.1 /workspaces/telegram-payment-gateway/packages/dashboard

(node:24327) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///workspaces/telegram-payment-gateway/postcss.config.js is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /workspaces/telegram-payment-gateway/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)
stderr | src/__tests__/P2POrders.test.tsx > P2POrders confirm/cancel flow > shows confirm dialog and calls cancelOrder on confirm
âš ï¸ React Router Future Flag Warning: React Router will begin wrapping state updates in `React.startTransition` in v7. You can use the `v7_startTransition` future flag to opt-in early. For more information, see https://reactrouter.com/v6/upgrading/future#v7_starttransition.
âš ï¸ React Router Future Flag Warning: Relative route resolution within Splat routes is changing in v7. You can use the `v7_relativeSplatPath` future flag to opt-in early. For more information, see https://reactrouter.com/v6/upgrading/future#v7_relativesplatpath.

 âœ“ src/__tests__/P2POrders.test.tsx  (1 test) 200ms

 Test Files  1 passed (1)
      Tests  1 passed (1)
   Start at  14:02:30
   Duration  1.79s (transform 146ms, setup 0ms, collect 520ms, tests 200ms, environment 571ms, prepare 157ms)


> @tg-payment/sdk@0.1.0 test
> echo "No tests" && exit 0

No tests
